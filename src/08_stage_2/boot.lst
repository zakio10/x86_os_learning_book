     1                                          BOOT_LOAD       equ     0x7C00                  ;ブートプログラムのロード位置
     2                                  
     3                                          ORG             BOOT_LOAD                       ;ブートアドレスをアセンブラに指示
     4                                  
     5                                  ;********************************************************************************************************
     6                                  ;マクロ
     7                                  ;********************************************************************************************************
     8                                  %include        "..\include\macro.s"
     1                              <1> %macro  cdecl   1-*.nolist
     2                              <1> 
     3                              <1>     %rep    %0 - 1
     4                              <1>         push    %{-1:-1}
     5                              <1>         %rotate -1
     6                              <1>     %endrep
     7                              <1>     %rotate -1
     8                              <1> 
     9                              <1>         call    %1
    10                              <1> 
    11                              <1>     %if 1 < %0
    12                              <1>         add     sp, (__BITS__ >> 3) * (%0 - 1)
    13                              <1>     %endif
    14                              <1> 
    15                              <1> %endmacro
     9                                  
    10                                  ;********************************************************************************************************
    11                                  ;エントリポイント
    12                                  ;********************************************************************************************************
    13                                  entry:
    14                                          ;---------------------------------------
    15                                          ;BPB(BIOS Parameter Block)
    16                                          ;---------------------------------------
    17 00000000 EB58                            jmp ipl                                    ;IPL(Initial Program Loader)(ブートプログラム)へジャンプ
    18 00000002 90<rept>                        times   90 - ($ - $$) db 0x90
    19                                  
    20                                          ;---------------------------------------
    21                                          ;IPL(Initial Program Loader)
    22                                          ;---------------------------------------
    23                                  ipl:
    24 0000005A FA                              cli                                     ;//割り込み禁止(IF = 1)
    25                                  
    26 0000005B B80000                          mov     ax, 0x0000                      ;AX = 0x0000;
    27 0000005E 8ED8                            mov     ds, ax                          ;DS = 0x0000;
    28 00000060 8EC0                            mov     es, ax                          ;ES = 0x0000;
    29 00000062 8ED0                            mov     ss, ax                          ;SS = 0x0000;
    30 00000064 BC007C                          mov     sp, BOOT_LOAD                   ;SP = 0x0000;
    31                                  
    32 00000067 FB                              sti                                     ;//割り込み許可(IF = 0)
    33                                  
    34 00000068 8816[B800]                      mov     [BOOT.DRIVE], dl                ;ブートドライブを保存
    35                                  
    36                                          ;---------------------------------------
    37                                          ;文字列を表示
    38                                          ;---------------------------------------
    39 0000006C 68[9800]E8480083C4-             cdecl   puts, .s0                       ;puts(.s0);
    39 00000074 02                 
    40                                          
    41                                          ;---------------------------------------
    42                                          ;次の512バイトを読み込む
    43                                          ;---------------------------------------
    44 00000075 B402                            mov     ah, 0x02                        ;AH = 読み込み命令
    45 00000077 B001                            mov     al, 1                           ;AL = 読み込みセクタ数
    46 00000079 B90200                          mov     cx, 0x0002                      ;CX = シリンダ/セクタ
    47 0000007C B600                            mov     dh, 0x00                        ;DH = ヘッド位置
    48 0000007E 8A16[B800]                      mov     dl, [BOOT.DRIVE]                ;DL = ドライブ位置
    49 00000082 BB007E                          mov     bx, 0x7C00 + 512                ;BX = オフセット(読み込み先アドレス用)
    50 00000085 CD13                            int     0x13                            ;if(CF = BIOS(0x13, 0x02))
    51 00000087 730C                    .10Q:   jnc     .10E                            ;{
    52 00000089 68[A500]E82B0083C4-     .10T:   cdecl   puts, .e0                       ;       puts(.e0);
    52 00000091 02                 
    53 00000092 E84400                          call    reboot                          ;       reboot();
    54                                  .10E:                                           ;}
    55                                  
    56                                          ;---------------------------------------
    57                                          ;次のステージへ移行
    58                                          ;---------------------------------------
    59 00000095 E96801                          jmp     stage_2                         ;ブート処理の第2ステージ
    60                                  
    61                                          ;---------------------------------------
    62                                          ;データ
    63                                          ;---------------------------------------
    64 00000098 426F6F74696E672E2E-     .s0     db      "Booting...", 0x0A, 0x0D, 0
    64 000000A1 2E0A0D00           
    65 000000A5 4572726F723A736563-     .e0     db      "Error:sector read", 0
    65 000000AE 746F72207265616400 
    66                                  
    67 000000B7 00                      ALIGN   2, db 0
    68                                  BOOT:                                           ;ブートドライブに関する情報
    69 000000B8 0000                    .DRIVE:    dw 0                                 ;ドライブ番号
    70                                  
    71                                  ;********************************************************************************************************
    72                                  ;モジュール
    73                                  ;********************************************************************************************************
    74                                  %include        "..\modules\real\puts.s"
     1                              <1> puts:
     2                              <1>         ;-----------------------------------
     3                              <1>         ;スタックフレームの構築
     4                              <1>         ;-----------------------------------
     5                              <1>                                             ;  + 4| 文字列へのアドレス
     6                              <1>                                             ;  + 2| IP(戻り番号)
     7 000000BA 55                  <1>         push    bp                          ;BP+ 0| BP(元の値)
     8 000000BB 89E5                <1>         mov     bp, sp                      ;-----|---------
     9                              <1> 
    10                              <1>         ;-----------------------------------
    11                              <1>         ;レジスタの保存
    12                              <1>         ;-----------------------------------
    13 000000BD 50                  <1>         push    ax
    14 000000BE 53                  <1>         push    bx
    15 000000BF 56                  <1>         push    si
    16                              <1> 
    17                              <1>         ;---------------------------------------
    18                              <1>         ;引数の取得
    19                              <1>         ;---------------------------------------
    20 000000C0 8B7604              <1>         mov     si, [bp + 4]                    ;SI = 文字列へのアドレス
    21                              <1> 
    22                              <1>         ;---------------------------------------
    23                              <1>         ;処理の開始
    24                              <1>         ;---------------------------------------
    25 000000C3 B40E                <1>         mov     ah, 0x0E                        ;テレタイプ式1文字出力を指定
    26 000000C5 BB0000              <1>         mov     bx, 0x0000                      ;ページ番号と文字色を0に設定
    27 000000C8 FC                  <1>         cld                                     ;DF = 0; //アドレス加算
    28                              <1> .10L:                                           ;do
    29                              <1>                                                 ;{
    30 000000C9 AC                  <1>         lodsb                                   ;       AL = *SI++;
    31                              <1> 
    32 000000CA 3C00                <1>         cmp     al, 0                           ;       if(0 == AL)
    33 000000CC 7404                <1>         je      .10E                            ;               break;
    34                              <1> 
    35 000000CE CD10                <1>         int     0x10                            ;       Int10(0x0E,AL); //文字出力
    36 000000D0 EBF7                <1>         jmp     .10L                            ;
    37                              <1> .10E:                                           ;}while(1);
    38                              <1> 
    39                              <1>         ;---------------------------------------
    40                              <1>         ;レジスタの復帰
    41                              <1>         ;---------------------------------------
    42 000000D2 5E                  <1>         pop     si
    43 000000D3 5B                  <1>         pop     bx
    44 000000D4 58                  <1>         pop     ax
    45                              <1> 
    46                              <1>         ;---------------------------------------
    47                              <1>         ;スタックフレームの破棄
    48                              <1>         ;---------------------------------------
    49 000000D5 89EC                <1>         mov     sp, bp
    50 000000D7 5D                  <1>         pop     bp
    51                              <1> 
    52 000000D8 C3                  <1>         ret
    75                                  %include        "..\modules\real\reboot.s"
     1                              <1> reboot:
     2                              <1>         ;-------------------------------------------
     3                              <1>         ;メッセージを表示                           
     4                              <1>         ;-------------------------------------------
     5 000000D9 68[F500]E8DBFF83C4- <1>         cdecl   puts, .s0                           ;//再起動メッセージを表示
     5 000000E1 02                  <1>
     6                              <1> 
     7                              <1>         ;-------------------------------------------
     8                              <1>         ;キー入力待ち
     9                              <1>         ;-------------------------------------------
    10                              <1> .10L:                                               ;do
    11                              <1>                                                     ;{
    12 000000E2 B410                <1>         mov     ah, 0x10                            ;   //キー入力待ち
    13 000000E4 CD16                <1>         int     0x16                                ;   AL = BIOS(0x16, 0x10);
    14                              <1>                                                     ;
    15 000000E6 3C20                <1>         cmp     al, ' '                             ;   ZF = (AL == ' ');
    16 000000E8 75F8                <1>         jne     .10L                                ;}while(!ZF);
    17                              <1> 
    18                              <1>         ;-------------------------------------------
    19                              <1>         ;改行を出力
    20                              <1>         ;-------------------------------------------
    21 000000EA 68[1301]E8CAFF83C4- <1>         cdecl   puts, .s1                           ;改行
    21 000000F2 02                  <1>
    22                              <1> 
    23                              <1>         ;-------------------------------------------
    24                              <1>         ;再起動
    25                              <1>         ;-------------------------------------------
    26 000000F3 CD19                <1>         int     0x19                                ;BIOS(0x19);    //reboot();
    27                              <1> 
    28                              <1>         ;-------------------------------------------
    29                              <1>         ;文字列データ
    30                              <1>         ;-------------------------------------------
    31 000000F5 0A0D50757368205350- <1> .s0     db  0x0A, 0x0D, "Push SPACE key to reboot...", 0
    31 000000FE 414345206B65792074- <1>
    31 00000107 6F207265626F6F742E- <1>
    31 00000110 2E2E00              <1>
    32 00000113 0A0D0A0D00          <1> .s1     db  0x0A, 0x0D, 0x0A, 0x0D, 0
    76                                  
    77                                  ;********************************************************************************************************
    78                                  ;ブートフラグ(先頭512バイトの終了)
    79                                  ;********************************************************************************************************
    80 00000118 00<rept>                        times   510 - ($ - $$) db 0x00
    81 000001FE 55AA                            db 0x55, 0xAA
    82                                  
    83                                  ;********************************************************************************************************
    84                                  ;ブート処理の第2ステージ
    85                                  ;********************************************************************************************************
    86                                  stage_2:
    87                                          ;---------------------------------------
    88                                          ;文字列の表示
    89                                          ;---------------------------------------
    90 00000200 68[0B02]E8B4FE83C4-             cdecl puts, .s0                         ;puts(.s0);
    90 00000208 02                 
    91                                  
    92                                          ;---------------------------------------
    93                                          ;処理の終了
    94                                          ;---------------------------------------
    95 00000209 EBFE                            jmp     $                               ;while(1); //無限ループ
    96                                  
    97                                          ;---------------------------------------
    98                                          ;データ
    99                                          ;---------------------------------------
   100 0000020B 326E64207374616765-     .s0     db      "2nd stage...", 0x0A, 0x0D, 0
   100 00000214 2E2E2E0A0D00       
   101                                  
   102                                  ;********************************************************************************************************
   103                                  ;パディング(このファイルは8Kバイトとする)
   104                                  ;********************************************************************************************************
   105 0000021A 00<rept>                        times (1024 * 8) - ($ - $$)     db 0    ;8Kバイト
